const currentURL=window.location.href;

if(currentURL.indexOf("index")!==-1){
    console.log("home");
    fetch('http://localhost:4200/home/index',{
        method:'GET',
        headers:{
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    }).then(response=>response.text()).then(data=>console.log(data));
}


window.onload = async function () {
    let getFilesResponse=await fetch('http://localhost:4200/home/index/all',{
        method:"GET",
        headers:{
            'x-user':1,
            'x-scope':'root'
        }
    });
    let fileArray=await getFilesResponse.json();
    clearFileCards();
    fileArray.forEach(file=>{
        generateFileCard(file);
    });

    var fileupload = document.getElementById("FileUpload");
    var filePath = document.getElementById("spanFilePath");
    var image = document.getElementById("imgFileUpload");
    image.onclick = function () {
        fileupload.click();
    };
    fileupload.onchange = async function () {
        let formData=new FormData();
        //formData.append("file",fileupload.files[0]);
        var fileName = fileupload.value.split('\\')[fileupload.value.split('\\').length - 1];
        filePath.innerHTML = "<b>Selected File: </b>" + fileName;
        let response=await fetch('http://localhost:4200/home/index/upload',{
            method:"POST",
            headers:{
                'x-filename':fileName,
                'x-user':1,
                'x-scope':'root'
            },
            body:fileupload.files[0]
        });
        if(response.status===200){
            let fileArray=await response.json();
            clearFileCards();
            fileArray.forEach(file=>{
                generateFileCard(file);
            });
          //  alert('The file has been uploaded successfully.');
        }else{
            alert('The file could not be uploaded. Probably duplicate?');
        }  
        this.value=null;
    };
};

function clearFileCards(){
    var divsToRemove = document.getElementsByClassName("contentContainerAutoGenerated");
    for (var i = divsToRemove.length-1; i >= 0; i--) {
        divsToRemove[i].remove();
    }
}

function generateFileCard(file){

    let directory="/assets/img/home"

    let div=document.getElementById("mainContent");
    let divContentContainer=document.createElement("div");
    divContentContainer.classList.add("contentContainerAutoGenerated");

    let divContentImageContainer=document.createElement("div");
    divContentImageContainer.classList.add("contentImageContainer");
    divContentImageContainer.classList.add("fileCard");

    let divFrontCard=document.createElement("div");
    divFrontCard.classList.add("frontRotate");
    divFrontCard.classList.add("rotatedCard");

    let imgContentImage=document.createElement("img");
    imgContentImage.classList.add("contentImage");
    imgContentImage.src=`${directory}/fileTypes/${file.filename.split('.').pop()}.svg`;
    
    divFrontCard.appendChild(imgContentImage);

    let divBackCard=document.createElement("div");
    divBackCard.classList.add("backRotate");
    divBackCard.classList.add("rotatedCard");

    let ul=document.createElement("ul");
    let size=document.createElement("li");
    size.innerHTML=`Size: ${file.size}Kb`;
    let extension=document.createElement("li");
    extension.innerHTML=`Extension: ${file.filename.split('.').pop()}`;
    let sharedChunks=document.createElement("li");

    let googleDrive=document.createElement("img");
    googleDrive.classList.add("backCardImage");
    googleDrive.src=`${directory}/drive.svg`;
    let oneDrive=document.createElement("img");
    oneDrive.classList.add("backCardImage");
    oneDrive.src=`${directory}/oneDrive.svg`;
    let dropbox=document.createElement("img");
    dropbox.classList.add("backCardImage");
    dropbox.src=`${directory}/dropbox.svg`;

    sharedChunks.appendChild(googleDrive);
    sharedChunks.appendChild(oneDrive);
    sharedChunks.appendChild(dropbox);

    let downloadButton=document.createElement("button");
    downloadButton.classList.add("backCardDownloadButton");
    downloadButton.innerHTML="Download";

    ul.appendChild(size);
    ul.appendChild(extension);
    ul.appendChild(sharedChunks);
    ul.appendChild(downloadButton);

    divBackCard.appendChild(ul);

    let contentTitle=document.createElement("div");
    contentTitle.classList.add("contentTitle");
    contentTitle.innerHTML=file.filename;

    divContentImageContainer.appendChild(divFrontCard);
    divContentImageContainer.appendChild(divBackCard);

    divContentContainer.appendChild(divContentImageContainer);
    divContentContainer.appendChild(contentTitle);

    div.appendChild(divContentContainer);

}